= S√âANCE 3 : Architecture Modulaire (Composition vs H√©ritage)
:author: Timoth√©e Robert et les IA
:toc: left
:toc-title: Sommaire
:icons: font
:source-highlighter: highlightjs
:imagesdir: images

== Le Pi√®ge de l'H√©ritage ("L'Enfer des Classes")

Jusqu'ici, nous avons utilis√© l'h√©ritage (`extends`) pour sp√©cialiser nos √©quipements.

* `Serveur` **est un** `EquipementReseau`.
* `Routeur` **est un** `EquipementReseau`.

C'est tr√®s bien pour la base. Mais imaginez maintenant que nous voulions g√©rer les **Services** install√©s sur ces serveurs (Apache, MySQL, SSH, FTP...).

=== La Mauvaise Id√©e (Ce qu'il ne faut PAS faire)
Si on continue avec l'h√©ritage, on serait tent√© de cr√©er :

* Une classe `ServeurWeb` (qui √©tend Serveur).
* Une classe `ServeurBaseDeDonnees` (qui √©tend Serveur).

**Mais que se passe-t-il si un client veut un serveur qui fait √Ä LA FOIS Web et Base de Donn√©es ?**
En PHP, l'h√©ritage multiple est impossible (`class SuperServeur extends ServeurWeb, ServeurSQL` -> ‚ùå ERREUR).

On finirait avec une structure monstrueuse et ing√©rable comme celle-ci :

.Diagramme de l'Enfer de l'H√©ritage
[mermaid]
....
classDiagram
    Equipement <|-- Serveur
    Serveur <|-- ServeurWeb
    Serveur <|-- ServeurSQL
    Serveur <|-- ServeurFTP
    Serveur <|-- ServeurWeb_Et_SQL
    Serveur <|-- ServeurWeb_Et_FTP
    Serveur <|-- ServeurSQL_Et_FTP
    Serveur <|-- Serveur_Tout_En_Un
    note "Explosion combinatoire !\nImpossible √† maintenir."
....

== La Solution : La Composition ("A un" vs "Est un")

Dans le d√©veloppement professionnel, on suit une r√®gle d'or :
[QUOTE]
"Favoriser la Composition (90%) sur l'H√©ritage (10%)."

L'id√©e est de changer de mentalit√© :

* Au lieu de dire : "Ce serveur **EST UN** serveur web".
* On va dire : "Ce serveur **A UN** service web install√© dessus".

C'est comme des **Lego**.

* **H√©ritage :** Vous sculptez un bloc de bois. Une fois sculpt√© en voiture, il ne peut pas devenir un avion.
* **Composition :** Vous avez une plaque de base (Le Serveur). Vous pouvez clipser dessus une brique "Web", une brique "SQL", ou les deux. C'est dynamique.

.Diagramme de Composition (La solution propre)
[mermaid]
....
classDiagram
    class Serveur {
        -services: array
        +ajouterService(Service s)
    }
    class Service {
        -nom: string
        -port: int
    }

    Serveur "1" *-- "*" Service : Poss√®de >
....

Ici, un Serveur "poss√®de" (Composition) une liste de Services.

== Mise en Pratique : La Brique "Service"

Nous allons cr√©er une classe qui repr√©sente un logiciel install√© (Apache, MySQL, etc.). Cette classe est **ind√©pendante**. Elle ne sait m√™me pas qu'elle est sur un serveur.

=== Cr√©ation de la classe Service
Cr√©ez le fichier `src/Service.php`.

[source,php]
----
<?php
namespace App;

class Service
{
    private string $nom;
    private int $port;
    private bool $estDemarre; // √âtat du service (Allum√©/√âteint)

    public function __construct(string $nom, int $port)
    {
        // Petit rappel de la S√©ance 2 : Validation !
        if ($port < 1 || $port > 65535) {
            throw new \Exception("SERVICE : Le port $port est invalide.");
        }

        $this->nom = $nom;
        $this->port = $port;
        $this->estDemarre = false; // Par d√©faut, un service est √©teint
    }

    public function demarrer(): void
    {
        $this->estDemarre = true;
    }

    public function arreter(): void
    {
        $this->estDemarre = false;
    }

    public function getStatut(): string
    {
        // Retourne un bout de HTML (Rouge ou Vert)
        $couleur = $this->estDemarre ? "green" : "red";
        $etat    = $this->estDemarre ? "ON" : "OFF";

        return "<span style='color:$couleur'>[$this->nom : $etat : Port $this->port]</span>";
    }
}
----

== Int√©gration : Modifier le Serveur

Maintenant, nous devons rendre notre `Serveur` capable d'accueillir ces `Service`s.

=== Modification de `src/Serveur.php`
Ouvrez votre classe `Serveur` existante et modifiez-la pour ajouter la gestion des services.

[source,php]
----
<?php
namespace App;

class Serveur extends EquipementReseau
{
    private string $os;

    // NOUVEAU : Un tableau pour stocker les objets "Service"
    private array $services = [];

    public function __construct(string $hostname, string $ip, string $os)
    {
        parent::__construct($hostname, $ip); // Validation auto du parent
        $this->os = $os;
    }

    /**
     * C'est ici que la COMPOSITION op√®re.
     * On injecte un objet "Service" √† l'int√©rieur du Serveur.
     */
    public function ajouterService(Service $service): void
    {
        // On ajoute l'objet re√ßu dans notre tableau
        $this->services[] = $service;
    }

    public function afficherStatut(): string
    {
        // 1. On affiche les infos de base du serveur
        $html = parent::afficherStatut() . " | OS : $this->os <br>";

        // 2. On boucle sur les services pour afficher leur √©tat
        if (empty($this->services)) {
            $html .= "<em>Aucun service install√©.</em>";
        } else {
            $html .= "<strong>Services : </strong>";
            foreach ($this->services as $service) {
                // On d√©l√®gue l'affichage √† la classe Service (Chacun son m√©tier)
                $html .= $service->getStatut() . " ";
            }
        }

        return $html;
    }
}
----



== Exercices Pratiques

Vous allez assembler les pi√®ces du puzzle.

=== Exercice 1 : Le D√©ploiement (20 min)
**Objectif :** Instancier des services et les "clipser" sur des serveurs via la composition.

Dans `public/index.php` (vous pouvez nettoyer le code des s√©ances pr√©c√©dentes) :

1.  Cr√©ez un serveur "SRV-WEB-01" (Debian).
2.  Cr√©ez un objet Service "Apache" sur le port 80.
3.  Cr√©ez un objet Service "SSH" sur le port 22.
4.  **Important :** D√©marrez le service Apache (m√©thode `demarrer()`), mais laissez SSH √©teint.
5.  Utilisez la m√©thode `ajouterService()` pour installer ces deux services sur le SRV-WEB-01.
6.  Affichez le statut du serveur.
* *Attendu :* Vous devriez voir les infos du serveur + "Apache : ON (Vert)" + "SSH : OFF (Rouge)".

=== Exercice 2 : Base de Donn√©es (15 min)
**Objectif :** Prouver la flexibilit√©.

1.  Cr√©ez un deuxi√®me serveur "SRV-DB-01" (Windows).
2.  Ajoutez-lui un service "MySQL" (Port 3306) et d√©marrez-le.
3.  Ajoutez-lui un service "RDP" (Port 3389) √©teint.
4.  Affichez le statut.
* *Observation :* Nous n'avons pas eu besoin de cr√©er une classe `ServeurWindowsSql`. La composition nous a permis de configurer cela dynamiquement !

=== Exercice 3 : L'Intelligence Collective (30 min / Difficile)
**Objectif :** Faire communiquer le Contenant (Serveur) et le Contenu (Service).

On veut que le Serveur change d'√©tat global si un de ses services est critique.

1.  Modifiez la classe `Service` :
* Ajoutez une propri√©t√© priv√©e `bool $estCritique` (et mettez-la dans le `__construct`).
* Ajoutez un "Getter" : `public function estCritique(): bool { return $this->estCritique; }`
* Ajoutez un "Getter" pour l'√©tat : `public function estDemarre(): bool { return $this->estDemarre; }`

2.  Modifiez la classe `Serveur` :
* Ajoutez une m√©thode `verifierSante(): string`.
* Cette m√©thode doit parcourir tous les services (`foreach`).
* **Logique :**
* Si un service est marqu√© "Critique" ET qu'il est "√âteint" -> Retournez "DANGER üî¥".
* Sinon -> Retournez "OK üü¢".

3.  Testez dans `index.php` :
* √âteignez Apache sur le serveur Web (alors qu'il est critique).
* Appelez `verifierSante()`. Cela doit afficher DANGER.

