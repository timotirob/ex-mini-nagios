= S√âANCE 2 : S√©curit√©, Validation & M√©thodes Statiques
:author: Timoth√©e Robert et les IA
:toc: left
:toc-title: Sommaire
:icons: font
:source-highlighter: highlightjs
:imagesdir: images

== Rappel du contexte "Mini-Nagios"

Lors de la s√©ance pr√©c√©dente, nous avons mod√©lis√© notre infrastructure r√©seau :

* `EquipementReseau` (Parent)
* `Serveur` et `Routeur` (Enfants)

Cependant, nous avons un **probl√®me de s√©curit√© majeur**.
Actuellement, un d√©veloppeur peut cr√©er un serveur avec une IP totalement bidon :

`$srv = new Serveur("Web", "Patate", "Linux");`

Notre application va planter plus tard, mais l'objet est cr√©√© quand m√™me. Aujourd'hui, nous allons s√©curiser la "porte d'entr√©e" de nos objets.

== Le Concept : M√©thodes Statiques (La Bo√Æte √† Outils)

Avant de s√©curiser nos classes, nous avons besoin d'outils de v√©rification.
En POO, quand une m√©thode n'a pas besoin de connaitre les donn√©es sp√©cifiques d'un objet (ni `$this->nom`, ni `$this->ip`), on dit qu'elle est **statique**.

C'est comme un outil pos√© sur l'√©tabli : tout le monde peut l'utiliser sans avoir besoin de construire un nouvel √©tabli √† chaque fois.

=== Focus : Vocabulaire et Concepts

Il est crucial de bien comprendre la terminologie. Vous entendrez souvent deux termes pour d√©signer la m√™me chose.

==== 1. Terminologie Exacte : Statique = Classe
* **Dans le code (PHP) :** On utilise le mot-cl√© `static`. On parle donc de **"M√©thode Statique"**.
* **Dans la conception (UML) :** Le terme th√©orique est **"M√©thode de Classe"** (par opposition √† "M√©thode d'Instance").

[NOTE]
.Retenez ceci
====
Les deux termes sont synonymes :

* _"M√©thode statique"_ d√©crit **comment** on la code.
* _"M√©thode de classe"_ d√©crit **√† qui** elle appartient.
====

==== 2. Tableau Comparatif (Moyen mn√©motechnique)

[cols="1,2,2", options="header"]
|===
| Concept | M√©thode d'Instance / Objet (Standard) | M√©thode de Classe (Statique)

| **C'est quoi ?**
| Une action que fait **un objet pr√©cis**.
| Une action que propose **la classe** (service g√©n√©ral).

| **Synonyme**
| M√©thode d'Objet
| M√©thode Statique

| **Exemple**
| `$voiture->demarrer()`
| `Validator::checkIp()`

| **Acc√®s aux donn√©es**
| Peut utiliser `$this` (Acc√®de √† ses propres donn√©es)
| **INTERDIT** d'utiliser `$this` (Ne connait aucun objet)

| **Op√©rateur PHP**
| `->` (La fl√®che)
| `::` (Les deux points)
|===

==== 3. L'Analogie de l'Atelier
Pour visualiser la diff√©rence, imaginez une usine de voitures :

* **L'Objet (La Voiture) :** Elle a ses propres options (couleur, moteur). Pour la d√©marrer, nous devons monter dans *cette* voiture pr√©cise (`$maVoiture->demarrer()`).
* **La Classe (L'Usine) :** Elle poss√®de des plans et des outils fix√©s aux murs.
* **Le Statique (L'Outil) :** Un outil de contr√¥le (ex: un m√®tre ruban) pos√© sur l'√©tabli appartient √† l'usine. Je n'ai pas besoin de construire une nouvelle voiture pour utiliser le m√®tre ruban. Je le prends directement sur l'√©tabli (`Usine::prendreMetre()`).

== Cr√©ation de la classe Validator
Nous allons cr√©er une classe qui ne sert qu'√† valider des donn√©es.

.   Dans `src/`, cr√©ez le fichier `Validator.php`.

[source,php]
----
<?php
namespace App;

class Validator
{
    /**
     * V√©rifie si une cha√Æne ressemble √† une IP v4 valide.
     * Cette m√©thode est STATIQUE (mot cl√© static).
     * On l'appelle directement par la Classe, pas par un objet.
     */
    public static function isIpValid(string $ip): bool
    {
        // filter_var est une fonction native de PHP tr√®s puissante pour la s√©curit√©
        if (filter_var($ip, FILTER_VALIDATE_IP)) {
            return true;
        } else {
            return false;
        }
    }
}
----

=== 1.2. Test rapide
Dans votre fichier `public/index.php`, testez cette m√©thode tout au d√©but (apr√®s l'autoload) :

[source,php]
----
// Appel d'une m√©thode statique avec "::" (Les deux points Paamayim Nekudotayim)
// Pas de "new Validator()", c'est inutile !

$ipTest = "999.0.0.1";
if (App\Validator::isIpValid($ipTest)) {
    echo "IP Valide";
} else {
    echo "IP Invalide (S√©curit√© activ√©e)";
}
----

[NOTE]
====
**A l√©loriser :**

* `->` : J'acc√®de √† quelque chose qui appartient √† **mon** objet (mon pr√©nom, mon IP).
* `::` : J'acc√®de √† quelque chose qui appartient √† **la classe** en g√©n√©ral (un outil, une configuration globale).
====

== S√©curisation : Le "Fail Fast" (√âchouer vite)

Maintenant que nous avons notre outil de validation, nous allons modifier la classe m√®re `EquipementReseau` pour interdire la cr√©ation d'un √©quipement si l'IP est mauvaise.

Nous allons utiliser les **Exceptions**. Une Exception est un interrupteur qui permet d' arr√™ter le programme quand une erreur grave survient.

=== Modification du Constructeur
Ouvrez `src/EquipementReseau.php` et modifiez le constructeur.

[source,php]
----
    // ... namespace et attributs ...

    public function __construct(string $hostname, string $ip)
    {
        // √âTAPE 1 : Validation d√©fensive
        // Avant m√™me d'assigner quoi que ce soit, on v√©rifie !
        if (!Validator::isIpValid($ip)) {
            // Si l'IP est pourrie, on lance une Exception (une erreur fatale contr√¥l√©e)
            throw new \Exception("ERREUR DE S√âCURIT√â : L'IP '$ip' n'est pas valide !");
        }

        // √âTAPE 2 : Assignation (seulement si l'√©tape 1 est pass√©e)
        $this->hostname = $hostname;
        $this->ip = $ip;
    }

    // ... reste de la classe ...
----

[IMPORTANT]
====
Notez le `\Exception`. Le backslash `\` devant indique qu'on utilise la classe Exception **native de PHP**, et non pas une classe qui serait dans notre namespace `App`.
====

=== Test du crash
Retournez dans `public/index.php`. Essayez de cr√©er un serveur avec une mauvaise IP.

[source,php]
----
$srvHack = new App\Serveur("Hacker", "Ceci n'est pas une IP", "Windows");
----

**R√©sultat attendu :** Votre page affiche une "Fatal Error" avec "Uncaught Exception".
C'est une **bonne nouvelle** ! Cela veut dire que votre classe refuse d√©sormais de cr√©er des objets corrompus.

== Gestion des Erreurs (Try / Catch)

Une page qui plante avec une erreur fatale, √ßa fait peur aux utilisateurs. Nous allons "attraper" (Catch) l'erreur pour l'afficher proprement.

Modifiez `public/index.php` pour envelopper vos cr√©ations d'objets dans un bloc de s√©curit√©.

[source,php]
----
<?php
require '../vendor/autoload.php';

use App\Serveur;
use App\Routeur;

echo "<h1>Console de Supervision</h1>";

try {
    // ON ESSAYE (TRY) d'ex√©cuter ce code dangereux

    $srvWeb = new Serveur("SRV-WEB", "192.168.1.10", "Debian");
    echo "<div style='color:green'>‚úÖ " . $srvWeb->afficherStatut() . "</div>";

    // Tentative de cr√©ation avec erreur
    echo "Tentative de cr√©ation du serveur corrompu...<br>";
    $srvBad = new Serveur("SRV-BAD", "999.999.999.999", "Windows");
    // La ligne ci-dessous ne sera JAMAIS ex√©cut√©e car √ßa plante juste avant
    echo "Ce message ne s'affichera pas.";

} catch (Exception $e) {
    // SI UNE ERREUR SURVIENT, on tombe ici
    // $e contient les infos sur l'erreur
    echo "<div style='background-color:#ffcccc; padding:10px; border:1px solid red; margin:10px;'>";
    echo "<strong>üõë ALERTE SYST√àME :</strong> " . $e->getMessage();
    echo "</div>";
}

echo "<p>Le script continue normalement apr√®s l'erreur...</p>";
----

**Analysez le flux :**

1.  Le code commence dans le `try`.
2.  Le premier serveur est cr√©√© (OK).
3.  Le deuxi√®me serveur tente d'√™tre cr√©√©.
4.  Le constructeur de `EquipementReseau` voit l'erreur et fait `throw new Exception`.
5.  L'ex√©cution **sort imm√©diatement** du `try` et saute dans le `catch`.
6.  Le message d'erreur s'affiche proprement.

== Interaction : Formulaire de Saisie

Arr√™tons de coder les serveurs "en dur". Faisons une interface pour que l'Administrateur Syst√®me puisse ajouter lui-m√™me des machines.

=== Cr√©ation du formulaire
Dans `public/`, cr√©ez un fichier `ajouter_machine.php`.

[source,html]
----
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Ajouter une machine</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        label { display:block; margin-top: 10px; }
        input, select { margin-bottom: 10px; padding: 5px; width: 300px; display:block; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer;}
    </style>
</head>
<body>
    <h2>Provisionner un nouveau Serveur</h2>

    <form method="POST" action="traitement.php">
        <label>Nom d'h√¥te (Hostname) :</label>
        <input type="text" name="hostname" required placeholder="Ex: SRV-DB-02">

        <label>Adresse IP :</label>
        <input type="text" name="ip" required placeholder="Ex: 192.168.1.50">

        <label>Syst√®me d'Exploitation :</label>
        <select name="os">
            <option value="Debian 12">Debian 12</option>
            <option value="Ubuntu 22.04">Ubuntu 22.04</option>
            <option value="Windows Server 2022">Windows Server 2022</option>
        </select>

        <button type="submit">Cr√©er le serveur</button>
    </form>
</body>
</html>
----

=== Traitement des donn√©es
Cr√©ez le fichier `public/traitement.php` qui va recevoir les donn√©es, utiliser nos classes et afficher le r√©sultat.

[source,php]
----
<?php
require '../vendor/autoload.php';
use App\Serveur;

// V√©rification : est-ce qu'on vient bien du formulaire ?
if ($_SERVER["REQUEST_METHOD"] == "POST") {

    // R√©cup√©ration des donn√©es du formulaire
    $nom = $_POST['hostname'];
    $ip  = $_POST['ip'];
    $os  = $_POST['os'];

    echo "<h3>R√©sultat du provisionning :</h3>";

    try {
        // C'est ici que la magie de la POO op√®re.
        // On tente de cr√©er l'objet avec les donn√©es utilisateur.
        // Si l'utilisateur a rentr√© n'importe quoi, le Constructeur lancera l'exception.

        $nouveauServeur = new Serveur($nom, $ip, $os);

        echo "<div style='color:green; border: 2px solid green; padding: 20px;'>";
        echo "‚úÖ Succ√®s ! <br>";
        echo $nouveauServeur->afficherStatut();
        echo "</div>";

    } catch (Exception $e) {
        // Gestion de l'erreur (IP invalide, etc.)
        echo "<div style='color:red; border: 2px solid red; padding: 20px;'>";
        echo "‚ùå √âchec du d√©ploiement : <br>";
        echo "<strong>" . $e->getMessage() . "</strong>";
        echo "</div>";
    }

    echo "<br><a href='ajouter_machine.php'>Retour au formulaire</a>";

} else {
    // Si quelqu'un essaye d'acc√©der √† cette page sans formulaire
    header("Location: ajouter_machine.php");
}
----

== Exercices Pratiques

=== Exercice 1 : Validation des Hostnames (20 min)
**Objectif :** Enrichir le Validator et les r√®gles m√©tiers.

1.  Dans la classe `Validator`, ajoutez une m√©thode statique `isHostnameValid(string $hostname): bool`.
* R√®gle : Le hostname doit contenir **uniquement** des lettres majuscules/minuscules, des chiffres et des tirets `-`. Pas d'espaces, pas d'accents.
* *Indice :* Utilisez une Regex (Expression R√©guli√®re) ou `preg_match`.
* *Regex sugg√©r√©e :* `/^[a-zA-Z0-9-]+$/`
2.  Modifiez le constructeur de `EquipementReseau` pour utiliser cette nouvelle validation. Si le hostname est invalide, lancez une Exception.
3.  Testez via le formulaire avec un nom comme "SRV WEB" (avec espace) -> Cela doit √©chouer.

=== Exercice 2 : Filtrage du Routeur (30 min)
**Objectif :** Appliquer la logique au Routeur.

1.  Modifiez le constructeur de la classe `Routeur`.
2.  Ajoutez une v√©rification sur le `$nbPorts`.
* Le nombre de ports doit √™tre **positif** (sup√©rieur √† 0).
* Il ne doit pas d√©passer 128 (limite physique arbitraire).
3.  Si la validation √©choue, lancez une Exception : "Un routeur doit avoir entre 1 et 128 ports".
4.  Cr√©ez une page `ajouter_routeur.php` (copier-coller du formulaire serveur) pour tester cette fonctionnalit√©.

