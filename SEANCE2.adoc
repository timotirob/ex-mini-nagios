= S√âANCE 2 : S√©curit√©, Validation & M√©thodes Statiques
:author: Timoth√©e Robert et les IA
:toc: left
:toc-title: Sommaire
:icons: font
:source-highlighter: highlightjs
:imagesdir: images

== Rappel du contexte "Mini-Nagios"

Lors de la s√©ance pr√©c√©dente, nous avons mod√©lis√© notre infrastructure r√©seau :

* `EquipementReseau` (Parent)
* `Serveur` et `Routeur` (Enfants)

Cependant, nous avons un **probl√®me de s√©curit√© majeur**.
Actuellement, un d√©veloppeur peut cr√©er un serveur avec une IP totalement bidon :

`$srv = new Serveur("Web", "Patate", "Linux");`

Notre application va planter plus tard, mais l'objet est cr√©√© quand m√™me. Aujourd'hui, nous allons s√©curiser la "porte d'entr√©e" de nos objets.

== Le Concept : M√©thodes Statiques (La Bo√Æte √† Outils)

Avant de s√©curiser nos classes, nous avons besoin d'outils de v√©rification.
En POO, quand une m√©thode n'a pas besoin de connaitre les donn√©es sp√©cifiques d'un objet (ni `$this->nom`, ni `$this->ip`), on dit qu'elle est **statique**.

C'est comme un outil pos√© sur l'√©tabli : tout le monde peut l'utiliser sans avoir besoin de construire un nouvel √©tabli √† chaque fois.

=== Focus : Vocabulaire et Concepts

Il est crucial de bien comprendre la terminologie. Vous entendrez souvent deux termes pour d√©signer la m√™me chose.

==== 1. Terminologie Exacte : Statique = Classe
* **Dans le code (PHP) :** On utilise le mot-cl√© `static`. On parle donc de **"M√©thode Statique"**.
* **Dans la conception (UML) :** Le terme th√©orique est **"M√©thode de Classe"** (par opposition √† "M√©thode d'Instance").

[NOTE]
.Retenez ceci
====
Les deux termes sont synonymes :

* _"M√©thode statique"_ d√©crit **comment** on la code.
* _"M√©thode de classe"_ d√©crit **√† qui** elle appartient.
====

==== 2. Tableau Comparatif (Moyen mn√©motechnique)

[cols="1,2,2", options="header"]
|===
| Concept | M√©thode d'Instance / Objet (Standard) | M√©thode de Classe (Statique)

| **C'est quoi ?**
| Une action que fait **un objet pr√©cis**.
| Une action que propose **la classe** (service g√©n√©ral).

| **Synonyme**
| M√©thode d'Objet
| M√©thode Statique

| **Exemple**
| `$voiture->demarrer()`
| `Validator::checkIp()`

| **Acc√®s aux donn√©es**
| Peut utiliser `$this` (Acc√®de √† ses propres donn√©es)
| **INTERDIT** d'utiliser `$this` (Ne connait aucun objet)

| **Op√©rateur PHP**
| `->` (La fl√®che)
| `::` (Les deux points)
|===

==== 3. L'Analogie de l'Atelier
Pour visualiser la diff√©rence, imaginez une usine de voitures :

* **L'Objet (La Voiture) :** Elle a ses propres options (couleur, moteur). Pour la d√©marrer, nous devons monter dans *cette* voiture pr√©cise (`$maVoiture->demarrer()`).
* **La Classe (L'Usine) :** Elle poss√®de des plans et des outils fix√©s aux murs.
* **Le Statique (L'Outil) :** Un outil de contr√¥le (ex: un m√®tre ruban) pos√© sur l'√©tabli appartient √† l'usine. Je n'ai pas besoin de construire une nouvelle voiture pour utiliser le m√®tre ruban. Je le prends directement sur l'√©tabli (`Usine::prendreMetre()`).

== Cr√©ation de la classe Validator
Nous allons cr√©er une classe qui ne sert qu'√† valider des donn√©es.

.   Dans `src/`, cr√©ez le fichier `Validator.php`.

[source,php]
----
<?php
namespace App;

class Validator
{
    /**
     * V√©rifie si une cha√Æne ressemble √† une IP v4 valide.
     * Cette m√©thode est STATIQUE (mot cl√© static).
     * On l'appelle directement par la Classe, pas par un objet.
     */
    public static function isIpValid(string $ip): bool
    {
        // filter_var est une fonction native de PHP tr√®s puissante pour la s√©curit√©
        if (filter_var($ip, FILTER_VALIDATE_IP)) {
            return true;
        } else {
            return false;
        }
    }
}
----

=== 1.2. Test rapide
Dans votre fichier `public/index.php`, testez cette m√©thode tout au d√©but (apr√®s l'autoload) :

[source,php]
----
// Appel d'une m√©thode statique avec "::" (Les deux points Paamayim Nekudotayim)
// Pas de "new Validator()", c'est inutile !

$ipTest = "999.0.0.1";
if (App\Validator::isIpValid($ipTest)) {
    echo "IP Valide";
} else {
    echo "IP Invalide (S√©curit√© activ√©e)";
}
----

[NOTE]
====
**A m√©moriser :**

* `->` : J'acc√®de √† quelque chose qui appartient √† **mon** objet (mon pr√©nom, mon IP).
* `::` : J'acc√®de √† quelque chose qui appartient √† **la classe** en g√©n√©ral (un outil, une configuration globale).
====

== S√©curisation : Le "Fail Fast" (√âchouer vite)

Maintenant que nous avons notre outil de validation, nous allons modifier la classe m√®re `EquipementReseau` pour interdire la cr√©ation d'un √©quipement si l'IP est mauvaise.

Nous allons utiliser les **Exceptions**. Une Exception est un interrupteur qui permet d' arr√™ter le programme quand une erreur grave survient.

=== Modification du Constructeur
Ouvrez `src/EquipementReseau.php` et modifiez le constructeur.

[source,php]
----
    // ... namespace et attributs ...

    public function __construct(string $hostname, string $ip)
    {
        // √âTAPE 1 : Validation d√©fensive
        // Avant m√™me d'assigner quoi que ce soit, on v√©rifie !
        if (!Validator::isIpValid($ip)) {
            // Si l'IP est pourrie, on lance une Exception (une erreur fatale contr√¥l√©e)
            throw new \Exception("ERREUR DE S√âCURIT√â : L'IP '$ip' n'est pas valide !");
        }

        // √âTAPE 2 : Assignation (seulement si l'√©tape 1 est pass√©e)
        $this->hostname = $hostname;
        $this->ip = $ip;
    }

    // ... reste de la classe ...
----

[IMPORTANT]
====
Notez le `\Exception`. Le backslash `\` devant indique qu'on utilise la classe Exception **native de PHP**, et non pas une classe qui serait dans notre namespace `App`.
====

=== Test du crash
Retournez dans `public/index.php`. Essayez de cr√©er un serveur avec une mauvaise IP.

[source,php]
----
$srvHack = new Serveur("Hacker", "Ceci n'est pas une IP", "Windows");
----

**R√©sultat attendu :** Votre page affiche une "Fatal Error" avec "Uncaught Exception".
C'est une **bonne nouvelle** ! Cela veut dire que votre classe refuse d√©sormais de cr√©er des objets corrompus.

== Gestion des Erreurs (Try / Catch)

Une page qui plante avec une erreur fatale, √ßa fait peur aux utilisateurs. Nous allons "attraper" (Catch) l'erreur pour l'afficher proprement.

Modifiez `public/index.php` pour envelopper vos cr√©ations d'objets dans un bloc de s√©curit√©.

[source,php]
----
<?php
require '../vendor/autoload.php';

use App\Serveur;
use App\Routeur;

echo "<h1>Console de Supervision</h1>";

try {
    // ON ESSAYE (TRY) d'ex√©cuter ce code dangereux

    $srvWeb = new Serveur("SRV-WEB", "192.168.1.10", "Debian");
    echo "<div style='color:green'>‚úÖ " . $srvWeb->afficherStatut() . "</div>";

    // Tentative de cr√©ation avec erreur
    echo "Tentative de cr√©ation du serveur corrompu...<br>";
    $srvBad = new Serveur("SRV-BAD", "999.999.999.999", "Windows");
    // La ligne ci-dessous ne sera JAMAIS ex√©cut√©e car √ßa plante juste avant
    echo "Ce message ne s'affichera pas.";

} catch (Exception $e) {
    // SI UNE ERREUR SURVIENT, on tombe ici
    // $e contient les infos sur l'erreur
    echo "<div style='background-color:#ffcccc; padding:10px; border:1px solid red; margin:10px;'>";
    echo "<strong>üõë ALERTE SYST√àME :</strong> " . $e->getMessage();
    echo "</div>";
}

echo "<p>Le script continue normalement apr√®s l'erreur...</p>";
----

**Analysez le flux :**

1.  Le code commence dans le `try`.
2.  Le premier serveur est cr√©√© (OK).
3.  Le deuxi√®me serveur tente d'√™tre cr√©√©.
4.  Le constructeur de `EquipementReseau` voit l'erreur et fait `throw new Exception`.
5.  L'ex√©cution **sort imm√©diatement** du `try` et saute dans le `catch`.
6.  Le message d'erreur s'affiche proprement.

Rappel:
Pour lancer et tester le programme, se placer dans le r√©pertoire public et dans la fen√™tre Terminal:

php -S localhost:8000


== Interaction : Formulaire de Saisie

Arr√™tons de coder les serveurs "en dur". Faisons une interface pour que l'Administrateur Syst√®me puisse ajouter lui-m√™me des machines.

=== Cr√©ation du formulaire
Dans `public/`, cr√©ez un fichier `ajouter_machine.php`.

[source,html]
----
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Ajouter un Serveur</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto;}
        label { display:block; margin-top: 15px; font-weight: bold;}
        input, select { margin-bottom: 10px; padding: 8px; width: 100%; display:block; box-sizing: border-box;}
        button { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; width: 100%; font-size: 1.1em;}
        button:hover { background: #218838; }
    </style>
</head>
<body>
<h2>üè≠ Provisionner un Serveur S√©curis√©</h2>

<form method="POST" action="traitement.php">
    <label>Nom d'h√¥te (Hostname) :</label>
    <input type="text" name="hostname" required placeholder="Ex: SRV-DB-02 (Lettres, chiffres, tirets)">

    <label>Adresse IP :</label>
    <input type="text" name="ip" required placeholder="Ex: 192.168.1.50">

    <label>Syst√®me d'Exploitation :</label>
    <select name="os">
        <option value="Debian 12">Debian 12</option>
        <option value="Ubuntu 24.04">Ubuntu 24.04</option>
        <option value="Windows Server 2022">Windows Server 2022</option>
        <option value="RedHat 9">RedHat 9</option>

        <option value="Windows XP">Windows XP (Interdit)</option>
        <option value="TempleOS">TempleOS (Interdit)</option>
    </select>

    <button type="submit">Cr√©er le serveur</button>
</form>
</body>
</html>
----

=== Traitement des donn√©es
Cr√©ez le fichier `public/traitement.php`.
Ce script va recevoir les donn√©es du formulaire, instancier la classe `Serveur` et afficher le r√©sultat.

[NOTE]
====
Pour l'instant, nous allons √©crire le code na√Øvement, sans gestion d'erreur, pour voir ce qu'il se passe en cas de probl√®me.
====

[source,php]
----
<?php
require '../vendor/autoload.php';
use App\Serveur;

echo "<a href='ajouter_machine.php'>&larr; Retour au formulaire</a><hr>";

// V√©rification de la m√©thode d'envoi
if ($_SERVER["REQUEST_METHOD"] == "POST") {

    // 1. R√©cup√©ration des donn√©es
    $nom = $_POST['hostname'];
    $ip  = $_POST['ip'];
    $os  = $_POST['os'];

    echo "<h3>R√©sultat du provisionning :</h3>";

    // 2. Tentative de cr√©ation (Code "Na√Øf")
    // ATTENTION : Si le constructeur lance une Exception, le script plantera ici !
    $nouveauServeur = new Serveur($nom, $ip, $os);

    // Si tout va bien, on affiche le succ√®s
    echo "<div style='color:green; border: 1px solid green; padding: 10px;'>";
    echo "‚úÖ Succ√®s ! <br>";
    echo $nouveauServeur->afficherStatut();
    echo "</div>";

} else {
    // Redirection si acc√®s direct sans POST
    header("Location: ajouter_machine.php");
    exit();
}
----

== Mise en situation : Test et Crash

C'est le moment de v√©rit√©. Nous allons v√©rifier que votre formulaire fonctionne et surtout, nous allons provoquer une erreur volontaire.

=== Lancement du Serveur (Check-list)

[IMPORTANT]
.R√®gle d'or
====
Le terminal qui lance le serveur doit **rester ouvert** pendant tout le test. Si vous le fermez, le site devient inaccessible.
====

1.  **Ouvrez votre terminal** (PowerShell, Command Prompt ou Terminal PHPStorm).
2.  **V√©rifiez votre position :** Vous devez √™tre √† la racine du projet `MiniNagios`.
3.  **Entrez dans le dossier public :**
+
[source,bash]
----
cd public
----
4.  **Lancez le serveur PHP :**
+
[source,bash]
----
php -S localhost:8000
----
5.  **V√©rification :** Le terminal doit afficher quelque chose comme _"Development Server (http://localhost:8000) started"_.

=== Acc√©der au bon fichier

Attention, par d√©faut le navigateur cherche `index.php`. Nous voulons tester notre nouveau fichier.

1.  Ouvrez votre navigateur (Chrome, Firefox...).
2.  **Copiez-collez cette URL exacte** dans la barre d'adresse :
+
`http://localhost:8000/ajouter_machine.php`
+
_(Si vous tapez juste localhost:8000, vous retomberez sur l'exercice pr√©c√©dent !)_

=== Le Sc√©nario de Test (√Ä faire dans l'ordre)

Nous allons jouer deux sc√®nes.

**Sc√®ne 1 : L'Administrateur Mod√®le (Succ√®s)**

1.  Remplissez le formulaire avec des donn√©es valides :
* Hostname : `SRV-WEB-02`
* IP : `192.168.1.60`
* OS : `Debian 12`
2.  Cliquez sur **"Cr√©er le serveur"**.
3.  **R√©sultat attendu :** Une page s'affiche avec ‚úÖ **Succ√®s** et le d√©tail de la machine.
4.  Cliquez sur "Retour au formulaire".

**Sc√®ne 2 : L'Administrateur T√™tu (Le Crash)**
C'est ici que nous testons votre s√©curit√©.

1.  Remplissez le formulaire pour pi√©ger le syst√®me :
* Hostname : `HACKED`
* IP : `10.0.0.500`
* OS : Choisissez ce que vous voulez dans la liste.
2.  Cliquez sur **"Cr√©er le serveur"**.
3.  **R√©sultat attendu :**
* Une erreur effrayante appara√Æt : `Fatal error: Uncaught Exception...`
* C'est la preuve que votre classe `Serveur` a bien refus√© l'IP invalide !
* Mais pour l'utilisateur, c'est un √©cran de plantage. C'est inacceptable en production.

=== √Ä vous de r√©parer !

Votre mission finale pour ce TP : transformer ce plantage (Fatal Error) en un message d'erreur propre.

1.  Retournez dans le code de `public/traitement.php`.
2.  Utilisez le bloc `try { ... } catch (Exception $e) { ... }` (vu en cours) pour encadrer la cr√©ation de l'objet.
3.  Une fois le code modifi√©, relancez le **Sc√©nario 2**.
4.  **Victoire :** La page ne plante plus, mais affiche un message rouge expliquant poliment le probl√®me.

== Exercices Pratiques

=== Exercice 1 : Validation des Hostnames (20 min)
**Objectif :** Enrichir le Validator et les r√®gles m√©tiers.

1.  Dans la classe `Validator`, ajoutez une m√©thode statique `isHostnameValid(string $hostname): bool`.
* R√®gle : Le hostname doit contenir **uniquement** des lettres majuscules/minuscules, des chiffres et des tirets `-`. Pas d'espaces, pas d'accents.
* *Indice :* Utilisez une Regex (Expression R√©guli√®re) ou `preg_match`.
* *Regex sugg√©r√©e :* `/^[a-zA-Z0-9-]+$/`
2.  Modifiez le constructeur de `EquipementReseau` pour utiliser cette nouvelle validation. Si le hostname est invalide, lancez une Exception.
3.  Testez via le formulaire avec un nom comme "SRV WEB" (avec espace) -> Cela doit √©chouer.

=== Exercice 2 : Filtrage du Routeur (30 min)
**Objectif :** Appliquer la logique au Routeur.

1.  Modifiez le constructeur de la classe `Routeur`.
2.  Ajoutez une v√©rification sur le `$nbPorts`.
* Le nombre de ports doit √™tre **positif** (sup√©rieur √† 0).
* Il ne doit pas d√©passer 128 (limite physique arbitraire).
3.  Si la validation √©choue, lancez une Exception : "Un routeur doit avoir entre 1 et 128 ports".
4.  Cr√©ez une page `ajouter_routeur.php` (copier-coller du formulaire serveur) pour tester cette fonctionnalit√©.

=== Exercice 3 : Validation Stricte des Imprimantes (20 min)
**Objectif :** Utiliser des tableaux pour restreindre les choix (Liste Blanche).

Votre DSI a d√©cid√© que seules certaines technologies d'impression sont autoris√©es. Fini les imprimantes exotiques !

1.  Dans la classe `Validator`, ajoutez une m√©thode statique `isPrinterTypeValid(string $type): bool`.
* Cette m√©thode doit v√©rifier si le type donn√© existe dans ce tableau autoris√© :
`["Laser", "Jet d'encre", "Thermique", "Matricielle"]`
* *Indice :* Utilisez la fonction PHP `in_array()`.
2.  Modifiez le constructeur de la classe `Imprimante`.
* Avant d'assigner `$this->type`, v√©rifiez sa validit√© via le Validator.
* Si le type n'est pas autoris√©, lancez une Exception : "Type d'imprimante non support√©".
3.  Testez en essayant de cr√©er une imprimante de type "3D" (ce qui doit √©chouer).

=== Exercice 4 : Standardisation des OS Serveurs (20 min)
**Objectif :** Appliquer une politique de conformit√© sur les Serveurs.

Pour √©viter que des administrateurs installent n'importe quoi (comme "Windows XP" ou "TempleOS"), nous allons filtrer les Syst√®mes d'Exploitation.

1.  Dans la classe `Validator`, ajoutez une m√©thode `isOsSupported(string $os): bool`.
* Liste autoris√©e : `["Debian 12", "Ubuntu 24.04", "Windows Server 2022", "RedHat 9"]`.
2.  Ouvrez la classe `Serveur`.
3.  Dans le constructeur, ajoutez l'appel √† cette validation pour l'argument `$os`.
4.  Si l'OS n'est pas dans la liste, l'Exception doit dire : "Politique DSI : L'OS '$os' est interdit."

=== Exercice 5 : S√©curit√© du Switch et VLAN (20 min)
**Objectif :** Valider une plage num√©rique (Range) sur un nouvel attribut.

Les switchs doivent √™tre configur√©s avec un VLAN de gestion (Management VLAN) pour √™tre administr√©s √† distance.

1.  Modifiez la classe `SwitchReseau` pour ajouter un nouvel attribut priv√© : `int $vlanGestion`.
2.  Mettez √† jour le constructeur pour accepter cet argument suppl√©mentaire :
`public function __construct(string $hostname, string $ip, int $nbPorts, int $vlanGestion)`
3.  Ajoutez une r√®gle de validation **directement dans le constructeur** (ou via le Validator si vous pr√©f√©rez) :
* Un ID de VLAN valide doit √™tre compris entre **1 et 4094**.
* Si ce n'est pas le cas, lancez une Exception.
4.  Mettez √† jour votre fichier `index.php` (ou le script de test) pour instancier un Switch avec un VLAN correct (ex: 10) et un incorrect (ex: 9999).
